<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<dom-module id="item-palette">
    <style>
    :host {
        display: left;
        position: relative;
        height: 100%;
        width: 100%;
    }
    
    .sequentialWrapper {
        display: flex;
        justify-content: stretch;
        flex-wrap: nowrap;
        overflow: hidden;
    }
    
    .iconItem {
        width: 24px;
        height: 24px;
        flex: 0 0 24px;
    }
    
    .textItem {
        margin-left: 5px;
        padding: 1px;
        overflow: hidden;
        flex: 0 1 100%;
        user-select: none;
    }
    
    .textContent {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        cursor: default;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    .subMenuItem {
        margin: 5px;
    }
    
    .rootMenuItem {
        margin: 1px;
        padding: 3px;
    }
    
    #toolbar {
        content-alignment: center;
        height: 90%;
        width: 90%;
        margin: 20px;
    }
    
    #insertion_point {
        widows: 100%;
        height: 100%;
    }
    
    #proxy {
        position: fixed;
        z-index: 101;
        display: none;
        opacity: 0.75;
        background: #f88;
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        display: flex;
        cursor: copy;
    }
    
    #proxy > * {
        width: 100% !important;
        height: 100% !important;
        margin: 0;
    }
    </style>
    <template>
        <paper-material elevated="3" id="toolbar">
            <template is="dom-if" if="{{items}}">
                <paper-menu selected="{{selecteitem}}">
                    <template is="dom-repeat" items="{{items}}">
                        <!-- if the item has items -> we are a category -->
                        <template is="dom-if" if="{{item.items}}">
                            <paper-submenu>
                                <!-- header -->
                                <paper-item on-track="_onMouseDown" class="menu-trigger rootMenuItem element">
                                    <div class="sequentialWrapper">
                                        <iron-icon class="iconItem" icon="{{item.icon}}"></iron-icon>
                                        <div class="textItem">
                                            <div class="textContent">{{item.name}}</div>
                                        </div>
                                    </div>
                                </paper-item>
                                <!-- <div class="sequentialWrapper">
                                        <iron-icon class="iconItem" icon="{{item.icon}}"></iron-icon>
                                        <div class="textItem">
                                            <div class="textContent">{{item.name}}</div>
                                        </div>
                                    </div> -->
                                <!-- </paper-item> -->
                                <!-- iterate content -->
                                <paper-menu class="menu-content">
                                    <template is="dom-repeat" items="{{item.items}}">
                                        <paper-item on-track="_onMouseDown" class="element">
                                            <div class="sequentialWrapper subMenuItem">
                                                <iron-icon class="iconItem" icon="{{item.icon}}"></iron-icon>
                                                <div class="textItem">
                                                    <div class="textContent">{{item.name}}</div>
                                                </div>
                                            </div>
                                        </paper-item>
                                    </template>
                                </paper-menu>
                            </paper-submenu>
                        </template>
                        <template is="dom-if" if="{{!item.items}}">
                            <paper-item on-track="_onMouseDown" class="rootMenuItem element">
                                <div class="sequentialWrapper">
                                    <iron-icon class="iconItem" icon="{{item.icon}}"></iron-icon>
                                    <div class="textItem">
                                        <div class="textContent">{{item.name}}</div>
                                    </div>
                                </div>
                            </paper-item>
                        </template>
                    </template>
                </paper-menu>
            </template>
            <div id="proxy" on-mouseover="_onProxyMouseOver" on-mouseout="_onProxyMouseOut" on-mouseup="_onProxyMouseUp">
            </div>
        </paper-material>
    </template>
    <script>
    define(['invoiced-canvashelper'], function(ch) {
        'use strict';
        Polymer({
            is: 'item-palette',
            properties: {
                droparea: {
                    type: String,
                    notify: true,
                    value: 'default',
                    observer: '_dropAreaChanged'
                },
                items: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [{
                            name: 'Headers',
                            icon: 'view-headline',
                            items: [{
                                name: 'Cooler header1',
                                icon: 'assignment',
                                createElement: function(evt) {
                                    return document.createElement('test-item');
                                }
                            }, {
                                name: 'Cooler header2',
                                icon: 'account-balance'
                            }]
                        }, {
                            name: 'Payment Info',
                            icon: 'payment'
                        }];
                    }
                },
                selectedItem: {
                    type: Object,
                    notify: true
                },

            },

            _onMouseDown: function(e) {
                'use strict';

                function getStyleProperties(style) {
                    'use strict';
                    var styles = {};
                    for (var j = 0, property; property = style[j]; j++) {
                        styles[property] = style[property];
                    }
                    return styles;
                }

                function createDragProxy(node, stripMargins) {
                    'use strict';
                    if (node.nodeType === Node.TEXT_NODE) {
                        return node.cloneNode();
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        let style = window.getComputedStyle(node);
                        if (style.display === 'none') {
                            return null;
                        }
                        let clone;
                        if (style.display === 'inline') {
                            clone = node.ownerDocument.createElement('span');
                        } else {
                            clone = node.ownerDocument.createElement('div');
                        }
                        for (let i = 0; i < node.attributes.length; i++) {
                            let attr = node.attributes[i];
                            clone.setAttribute(attr.name, attr.value);
                        }
                        let properties = getStyleProperties(style);
                        let styleText = Object.keys(properties)
                            .filter(function(prop) {
                                return !(stripMargins && prop.startsWith('margin'));
                            })
                            .map(function(prop) {
                                return `${prop}: ${properties[prop]}`;
                            })
                            .join('; ');
                        clone.setAttribute('style', styleText);
                        for (let i = 0; i < node.childNodes.length; i++) {
                            let child = createDragProxy(node.childNodes[i]);
                            if (child) {
                                clone.appendChild(child);
                            }
                        }
                        return clone;
                    }
                    return null;
                }

                function setPosition(dragTarget, pos, element) {

                    element.style.top = (pos.x - parseInt(dragTarget.offsetTop, 10)) + 'px';
                    element.style.left = (pos.y - parseInt(dragTarget.offsetLeft, 10)) +'px';
                    element.style.position = 'absolute';
                    return pos;
                }
                switch (e.detail.state) {
                    case 'start':
                        this.message = 'Tracking started!';
                        var element = e.currentTarget;
                        var dataItem = element.dataHost.__data__.item;
                        //var newElement = dataItem.createElement('div');
                        var newElement = document.createElement('test-item');
                        newElement.classList.add('element');
                        // Polymer.dom(newElement).append('draggable', true);
                        this.$.currentlyDragged = newElement;
                        let proxy = createDragProxy(this.$.currentlyDragged, true);
                        this.$.proxy.innerHTML = proxy.outerHTML;
                        let bounds = element.getBoundingClientRect();
                        this._updateDragProxy({
                            left: e.detail.x,
                            top: e.detail.y,
                            width: this.$.currentlyDragged.offsetWidth,
                            height: this.$.currentlyDragged.offsetHeight,
                        });
                        break;
                    case 'track':
                        this.message = 'Tracking in progress... ' +
                            e.detail.x + ', ' + e.detail.y;
                        this._updateDragProxy({
                            left: e.detail.x,
                            top: e.detail.y,
                            width: this.$.currentlyDragged.offsetWidth,
                            height: this.$.currentlyDragged.offsetHeight
                        });

                        break;
                    case 'end':
                        this.message = 'Tracking ended!';
                        this._hideDragProxy(this.$.currentlyDragged);
                        Polymer.dom(this.droparea).appendChild(this.$.currentlyDragged);
                        Polymer.dom.flush();
                        var pos = setPosition(this.droparea, {
                            x: parseInt(this.$.proxy.style.top, 10),
                            y: parseInt(this.$.proxy.style.left, 10)
                        }, this.$.currentlyDragged)

                        break;
                }
            },
            _onProxyMouseOver(e) {
                e.stopPropagation();
            },
            _onProxyMouseOut(e) {
                e.stopPropagation();
            },
            _onProxyMouseUp() {
                // this is a hack to keep the mini-nav from expanding when the proxy
                // is released
                this.fire('designer-mini-nav-collapse');
            },
            _updateDragProxy(bounds) {
                var style = this.$.proxy.style;
                style.display = 'block';
                style.top = bounds.top + 'px';
                style.left = bounds.left + 'px';
                style.width = bounds.width + 'px';
                style.height = bounds.height + 'px';
            },
            _hideDragProxy() {
                var style = this.$.proxy.style;
                style.display = 'none';
            },
            _dropAreaChanged: function(e) {
                var changed = true;
            },
            _itemsChanged: function(e) {
                var changed = true;
            },
            drag: function(e) {

                function guid() {
                    function s4() {
                        return Math.floor((1 + Math.random()) * 0x10000)
                            .toString(16)
                            .substring(1);
                    }
                    return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                        s4() + '-' + s4() + s4() + s4();
                }

            }

        });
    });
    </script>
</dom-module>
